<!DOCTYPE html>
    <html>

    <head>
    <title>LDS-006-Lidar-Sensor-Library - Demonstator</title>
    <script src="/protobuf-7.2.2.js"></script>
    <script type="text/javascript">

        var max_distance = 1000;
        var is_started = false;
        var source = null;
        function httpGetAsync(theUrl, callback) {
            let xmlHttpReq = new XMLHttpRequest();
            xmlHttpReq.onreadystatechange = function () {
            if (xmlHttpReq.readyState == 4 && xmlHttpReq.status == 200) callback(xmlHttpReq.responseText);
            };
            xmlHttpReq.open("GET", theUrl, true); // true for asynchronous
            xmlHttpReq.send(null);
        }
        function start() {
            _start();
        }
        function pb_StrToBin(str) {
            // expecting data in format b'...'
            // strip leading b\' and trailing \'
            str = str.substr(2, str.length - 3)

            // convert to binary
            result = [];
            for (var i = 0; i < str.length;) {
                if (str[i] === "\\"){
                    i++;
                    if(str[i] === "x") {
                        i++;
                        result.push(parseInt(str[i] + str[i+1], 16));
                        i+=2;
                    } else {
                        if(str[i] === "n") {
                            result.push(10);
                        } else if(str[i] === "r") {
                            result.push(13);
                        } else if(str[i] === "t") {
                            result.push(9);
                        } else if(str[i] === "b") {
                            result.push(8);
                        } else if(str[i] === "f") {
                            result.push(12);
                        } else if(str[i] === "v") {
                            result.push(11);
                        } else if(str[i] === "0") {
                            result.push(0);
                        } else if(str[i] === "\\") {
                            result.push(92);
                        } else if(str[i] === "'") {
                            result.push(39);
                        } else if(str[i] === "\"") {
                            result.push(34);
                        } else {
                            throw "Invalid escape sequence: " + str[i] + " at position " + i;
                        }
                        i++;
                    }
                } else {
                    result.push(str[i].charCodeAt());
                    i++;
                }
            }
            return new Uint8Array(result);
        }
        async function _start(){
            if(window.is_started == true)
                return;
            window.is_started = true;
            httpGetAsync('/start', function (data) {})

            var canvas = document.getElementById("lidarCanvas");
            x = canvas.width / 2;
            y = canvas.height / 2;
            var ctx = canvas.getContext("2d");

            const root = await protobuf.load("msgLDS.proto");
            const testMessage = root.lookupType("msgLDS.msgLDS");
            window.source = new EventSource('/lidar');
            window.source.onmessage = function(event) {
                try {
                    data = pb_StrToBin(event.data);
                    const err = testMessage.verify(data);
                    if(err) { throw err; }
                    const msg = testMessage.decode(data);
                    //console.log("Data length: " + data.length)
                    //console.log("Message length: " + msg.data.length)
                    //console.log(testMessage.toObject(msg));
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.beginPath();

                    ctx.moveTo(x, y * (1 + Math.floor( data.values[0] / max_distance)) );
                    var dc = 0;
                    var pc = 0;
                    for(var i = 0; i < msg.data.length; i++) {
                        if(msg.data[i].certainty){
                            var distance = msg.data[i].distance;
                            if(distance > max_distance)
                                max_distance = distance
                            max_distance -= 10;
                            distance = ( distance / (max_distance) * x);
                            var angle = msg.data[i].angle * Math.PI / 180;
                            var x2 = x + distance * Math.sin(angle);
                            var y2 = y + distance * Math.cos(angle);
                            ctx.lineTo(x2, y2);
                            ctx.arc(x2, y2, 2, 0, 2*Math.PI, 0);
                            pc++;
                        }
                        dc++;
                    }
                    ctx.stroke();
                    console.log("Data received #" + dc + "\nData print #" + pc)
                } catch (e) {
                    if (e instanceof protobuf.util.ProtocolError) {
                        console.log("Error (ProtocolError): " + e);
                    } else {
                        console.log("Error (other): " + e);
                        throw e;
                    }
                }
            }
        }
        function pause() {
            httpGetAsync('/pause', function (data) {})
        }
        function stop() {
            window.source.close();
            window.is_started = false;
            httpGetAsync('/stop', function (data) {})
        }
    </script>
    </head>
    <body>
    <h2>LDS-006-Lidar-Sensor-Library - Demonstator</h2>

    <button onclick="start()">Start</button>
    <button onclick="stop()">Stop</button>
    <button onclick="pause()">Pause</button>
    <br>
    <canvas id="lidarCanvas" width="900" height="900" style="border:1px solid #000000;"></canvas>
    </body>
    </html>